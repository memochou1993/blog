---
title: 《Docker：從入門到實踐》學習筆記（二）：資料卷、網路、安全
permalink: 《Docker：從入門到實踐》學習筆記（二）：資料卷、網路、安全
date: 2022-02-28 20:36:06
tags: ["環境部署", "Docker"]
categories: ["環境部署", "Docker", "《Docker：從入門到實踐》學習筆記"]
---

## 前言

本文複習 Docker 相關概念與指令。

## 資料卷

資料卷是一種可供一或多個容器使用的特殊目錄，它繞過 UFS（通用快閃記憶體儲存），提供很多有用的特性：

- 資料卷可以在容器之間共享和重用。
- 對資料卷的修改會立即生效。
- 對資料卷的更新，不會影響映像檔。
- 卷會一直存在，直到沒有容器使用。

### 建立資料卷

使用 `-v` 參數建立一個資料卷並掛載到容器裡。

```BASH
docker run -ti --name test -v /dbdata ubuntu bash
```

也可以指定掛載一個本地主機的目錄到容器裡。

```BASH
docker run -ti --name test -v ~/Workspace/docker:/dbdata ubuntu bash
```

注意，本地目錄的路徑必須是絕對路徑，如果目錄不存在，Docker 會自動建立。

Docker 掛載資料卷的預設權限是讀寫，使用者也可以透過 `:ro` 參數指定為唯讀。

```BASH
docker run -ti --name test -v ~/Workspace/docker:/dbdata:ro ubuntu bash
```

### 建立資料卷容器

如果有一些持續更新的資料需要在容器之間共享，最好建立資料卷容器。資料卷容器其實就是一個一般的容器，專門用來提供資料卷供其它容器掛載。

首先，建立一個名為 `dbdata` 的資料卷容器。

```BASH
docker run -d --name dbdata -v /dbdata ubuntu
```

然後，在其他容器中使用 `--volumes-from` 參數來掛載 `dbdata` 容器中的資料卷。

```BASH
docker run -d --volumes-from dbdata --name test1 ubuntu
docker run -d --volumes-from dbdata --name test2 ubuntu
```

使用 `docker rm -v` 命令來刪除關聯的容器。

```BASH
docker rm -v dbdata test1 test2
```

### 備份

首先，建立一個名為 `dbdata` 的資料卷容器。

```BASH
docker run -t -d --name dbdata -v /dbdata ubuntu
```

使用 `--volumes-from` 參數來建立一個載入 `dbdata` 容器卷的容器，並從本地主機掛載當前目錄到容器的 `/backup` 目錄，再使用 `tar` 指令進行壓縮。

```BASH
docker run --volumes-from dbdata -v $(pwd):/backup ubuntu tar cvfP /backup/backup.tar /dbdata
```

### 復原

首先，建立一個名為 `dbdata2` 的資料卷容器。

```BASH
docker run -t -d --name dbdata2 -v /dbdata ubuntu
```

使用 `--volumes-from` 參數來建立一個載入 `dbdata2` 容器卷的容器，並從本地主機掛載當前目錄到容器的 `/backup` 目錄，再使用 `tar` 指令進行解壓縮。

```BASH
docker run -t -d --volumes-from dbdata2 -v $(pwd):/backup ubuntu tar xvfP /backup/backup.tar
```

## 網路

### 外部存取

容器中可以執行一些網路應用，要讓外部也可以存取這些應用，可以透過 `-P` 或 `-p` 參數來指定連接埠映射。

當使用 `-P` 參數時，Docker 會暴露所有容器開放的網路連接埠。

```BASH
docker run -d -P --name nginx nginx
docker ps
CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                   NAMES
733f68958e83   nginx     "/docker-entrypoint.…"   3 seconds ago   Up 2 seconds   0.0.0.0:55001->80/tcp   nginx
```

當使用 `-p` 參數時，可以將本地的 `80` 連接埠映射到容器的 `80` 連接埠。

```BASH
docker run -d -p 80:80 --name nginx nginx
docker ps
CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS        PORTS                NAMES
d65ab2cd7336   nginx     "/docker-entrypoint.…"   2 seconds ago   Up 1 second   0.0.0.0:80->80/tcp   nginx
```

或者，可以指定一個特定位址，比如 `127.0.0.1` 的 `80` 連接埠。

```BASH
docker run -d -p 127.0.0.1:80:80 --name nginx nginx
docker ps
CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                  NAMES
117d76809326   nginx     "/docker-entrypoint.…"   3 seconds ago   Up 2 seconds   127.0.0.1:80->80/tcp   nginx
```

使用 `docker port` 指令查看連接埠。

```BASH
docker port nginx
80/tcp -> 0.0.0.0:80
```

使用 `docker inspect` 查看容器的網路設定。

```BASH
docker inspect nginx
```

### 容器互連

建立一個資料庫容器。

```BASH
docker run -d --name db mysql/mysql-server
```

使用 `--link` 參數，將它連接到資料庫容器。格式為 `name:alias`，其中 `name` 是要連接的容器名稱，`alias` 是這個連接的別名。

```BASH
docker run -d -p 80:80 --name ubuntu --link db:db ubuntu
```

Docker 在兩個互聯的容器之間創建了一個安全隧道，而且不用映射它們的連接埠到宿主主機上。在啟動資料庫容器的時候並沒有使用 `-p` 和 `-P` 參數，從而避免了暴露資料庫連接埠到外部網路上。

使用 `env` 指令來查看 `ubuntu` 容器的環境變數。

```ENV
DB_PORT_33060_TCP_ADDR=172.17.0.4
DB_PORT_3306_TCP_PORT=3306
...
```

其中 `DB_` 開頭的環境變數是供 `ubuntu` 容器連接 `db` 容器使用，前綴採用大寫的連接別名。

除了環境變數，Docker 還新增 host 訊息到父容器的 `/etc/hosts` 的檔案。

```BASH
cat /etc/hosts
127.0.0.1	localhost
::1	localhost ip6-localhost ip6-loopback
fe00::0	ip6-localnet
ff00::0	ip6-mcastprefix
ff02::1	ip6-allnodes
ff02::2	ip6-allrouters
172.17.0.4	db 843b83837114
172.17.0.6	ee6e5abc9f65
```

另外，可以在 `ubuntu` 容器中安裝 `ping` 指令來測試跟 `db` 容器的連通。

```BASH
apt-get update && apt-get install -yqq inetutils-ping
```

使用 `ping` 指令測試連通。

```BASH
ping db
PING db (172.17.0.4): 56 data bytes
64 bytes from 172.17.0.4: icmp_seq=0 ttl=64 time=0.127 ms
64 bytes from 172.17.0.4: icmp_seq=1 ttl=64 time=0.297 ms
```

最後，使用者可以連接多個子容器到父容器，比如可以連接多個應用程式容器到 `db` 容器上。

## 安全

TODO

## 參考資料

- [Docker：從入門到實踐](https://github.com/yeasy/docker_practice)
